services:
  mihomo:
    image: ${MIHOMO_IMAGE:-docker.io/metacubex/mihomo:latest}
    container_name: mihomo-gateway
    restart: unless-stopped
    network_mode: host
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./runtime:/root/.config/mihomo
    command:
      - -d
      - /root/.config/mihomo

  docker-socket-proxy:
    image: ${DOCKER_SOCKET_PROXY_IMAGE:-docker.io/tecnativa/docker-socket-proxy:0.3.0}
    container_name: mihomo-docker-socket-proxy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
      - /run
    ports:
      - "127.0.0.1:23750:2375"
    environment:
      CONTAINERS: 1
      IMAGES: 1
      INFO: 1
      PING: 1
      POST: 1
      VERSION: 1
      DELETE: 1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  subscription-sync:
    build:
      context: .
      dockerfile: Dockerfile.sync
      args:
        DOCKER_CLI_IMAGE: ${DOCKER_CLI_IMAGE:-docker.io/docker:27-cli}
    image: ${SYNC_WORKER_IMAGE:-proxy-server/subscription-sync:local}
    container_name: mihomo-subscription-sync
    restart: unless-stopped
    stop_grace_period: 25s
    depends_on:
      - docker-socket-proxy
    env_file:
      - ./.env
    environment:
      DOCKER_HOST: tcp://127.0.0.1:23750
    network_mode: host
    working_dir: /opt/app
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "test -s /opt/app/runtime/status.json"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s
    volumes:
      - ./runtime:/opt/app/runtime
      - ./.env:/opt/app/.env:ro
    command:
      - ./scripts/subscription-worker.sh
